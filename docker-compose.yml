services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: gaussdevagency_app
    profiles: ["dev"]
    ports:
      - "5173:5173"
    environment:
      - HOST=0.0.0.0
    working_dir: /app
    volumes:
      - .:/app
      - pnpm-store:/root/.local/share/pnpm/store
      - pnpm-node-modules:/app/node_modules
    command: >
      sh -c "pnpm install --frozen-lockfile &&
      pnpm dev --host 0.0.0.0 --port 5173"
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gaussdevagency_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${SSL_CERT_SOURCE_DIR:-/etc/ssl/gaussdev}:/etc/ssl/gaussdev:ro
    environment:
      - SSL_CERT_PATH=/etc/ssl/gaussdev/gaussdev_com.fullchain.crt
      - SSL_KEY_PATH=/etc/ssl/gaussdev/gaussdev.com.key
      - ALLOW_HTTP_FALLBACK=${ALLOW_HTTP_FALLBACK:-false}
    restart: unless-stopped

volumes:
  pnpm-store:
  pnpm-node-modules:
